name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-linux:
    name: Build on Linux
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Qt6
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.5.3'
          host: 'linux'
          target: 'desktop'
          arch: 'gcc_64'
          modules: 'qtnetworkauth qtwebsockets'

      - name: Configure CMake
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER=g++ \
            -DWIDGETEER_BUILD_SAMPLE=ON \
            -DWIDGETEER_BUILD_TESTS=ON

      - name: Build
        run: cmake --build build --parallel $(nproc)

      - name: Run Unit Tests
        run: |
          cd build
          ctest --output-on-failure
        env:
          QT_QPA_PLATFORM: offscreen

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: widgeteer-linux
          path: |
            build/libwidgeteer.a
            build/sample/widgeteer_sample

  coverage:
    name: Code Coverage
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Qt6
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.5.3'
          host: 'linux'
          target: 'desktop'
          arch: 'gcc_64'
          modules: 'qtnetworkauth qtwebsockets'

      - name: Install lcov
        run: sudo apt-get update && sudo apt-get install -y lcov

      - name: Configure CMake (Debug with coverage)
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_COMPILER=g++ \
            -DWIDGETEER_BUILD_SAMPLE=ON \
            -DWIDGETEER_BUILD_TESTS=ON

      - name: Build
        run: cmake --build build --parallel $(nproc)

      - name: Run tests and generate coverage
        run: |
          # Reset counters
          lcov --zerocounters --directory build

          # Capture baseline
          lcov --capture --initial --directory build --output-file coverage_base.info

          # Run tests
          cd build && ctest --output-on-failure && cd ..

          # Capture test coverage
          lcov --capture --directory build --output-file coverage_test.info

          # Combine
          lcov --add-tracefile coverage_base.info --add-tracefile coverage_test.info --output-file coverage_combined.info

          # Filter out system/Qt/test files
          lcov --remove coverage_combined.info \
            '/usr/*' \
            '*/Qt/*' \
            '*/qt6/*' \
            '*/tests/*' \
            '*moc_*' \
            '*_autogen/*' \
            --output-file coverage.info
        env:
          QT_QPA_PLATFORM: offscreen

      - name: Coverage summary
        run: |
          echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
          lcov --summary coverage.info 2>&1 | tee -a $GITHUB_STEP_SUMMARY

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.info
          flags: unittests
          name: qt-widgeteer-coverage
          fail_ci_if_error: true
          verbose: true

  test-integration:
    name: Integration Tests
    runs-on: ubuntu-22.04
    needs: build-linux

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Qt6
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.5.3'
          host: 'linux'
          target: 'desktop'
          arch: 'gcc_64'
          modules: 'qtnetworkauth qtwebsockets'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb libxcb-xinerama0 libxcb-cursor0
          pip install websockets

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: widgeteer-linux
          path: build

      - name: Make executable
        run: chmod +x build/sample/widgeteer_sample

      - name: Run integration tests
        run: |
          # Start Xvfb for headless GUI testing
          export DISPLAY=:99
          Xvfb :99 -screen 0 1024x768x24 &
          sleep 2

          # Start the sample application in background
          ./build/sample/widgeteer_sample 9000 &
          APP_PID=$!
          sleep 3

          # Run the Python tests
          cd tests
          python test_executor.py sample_tests.json --port 9000 --verbose || TEST_EXIT=$?

          # Clean up
          kill $APP_PID 2>/dev/null || true

          exit ${TEST_EXIT:-0}

  lint:
    name: Lint
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run pre-commit
        uses: pre-commit/action@v3.0.1
